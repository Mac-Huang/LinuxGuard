[
  {
    "sha": "e34a79b96ab9d49ed8b605fee11099cf3efbb428",
    "message": "Merge tag 'net-6.16-rc4' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net\n\nPull networking fixes from Paolo Abeni:\n \"Including fixes from bluetooth and wireless.\n\n  Current release - regressions:\n\n   - bridge: fix use-after-free during router port configuration\n\n  Current release - new code bugs:\n\n   - eth: wangxun: fix the creation of page_pool\n\n  Previous releases - regressions:\n\n   - netpoll: initialize UDP checksum field before checksumming\n\n   - wifi: mac80211: finish link init before RCU publish\n\n   - bluetooth: fix use-after-free in vhci_flush()\n\n   - eth:\n      - ionic: fix DMA mapping test\n      - bnxt: properly flush XDP redirect lists\n\n  Previous releases - always broken:\n\n   - netlink: specs: enforce strict naming of properties\n\n   - unix: don't leave consecutive consumed OOB skbs.\n\n   - vsock: fix linux/vm_sockets.h userspace compilation errors\n\n   - selftests: fix TCP packet checksum\"\n\n* tag 'net-6.16-rc4' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (38 commits)\n  net: libwx: fix the creation of page_pool\n  net: selftests: fix TCP packet checksum\n  atm: Release atm_dev_mutex after removing procfs in atm_dev_deregister().\n  netlink: specs: enforce strict naming of properties\n  netlink: specs: tc: replace underscores with dashes in names\n  netlink: specs: rt-link: replace underscores with dashes in names\n  netlink: specs: mptcp: replace underscores with dashes in names\n  netlink: specs: ovs_flow: replace underscores with dashes in names\n  netlink: specs: devlink: replace underscores with dashes in names\n  netlink: specs: dpll: replace underscores with dashes in names\n  netlink: specs: ethtool: replace underscores with dashes in names\n  netlink: specs: fou: replace underscores with dashes in names\n  netlink: specs: nfsd: replace underscores with dashes in names\n  net: enetc: Correct endianness handling in _enetc_rd_reg64\n  atm: idt77252: Add missing `dma_map_error()`\n  bnxt: properly flush XDP redirect lists\n  vsock/uapi: fix linux/vm_sockets.h userspace compilation errors\n  wifi: mac80211: finish link init before RCU publish\n  wifi: iwlwifi: mvm: assume '1' as the default mac_config_cmd version\n  selftest: af_unix: Add tests for -ECONNRESET.\n  ...",
    "author": "Linus Torvalds",
    "date": "2025-06-26T09:13:27-07:00",
    "files_changed": [
      "drivers/atm/idt77252.c",
      "drivers/bluetooth/btintel_pcie.c",
      "drivers/bluetooth/hci_qca.c",
      "drivers/net/ethernet/broadcom/bnxt/bnxt.c",
      "drivers/net/ethernet/freescale/enetc/enetc_hw.h",
      "drivers/net/ethernet/microsoft/mana/gdma_main.c",
      "drivers/net/ethernet/pensando/ionic/ionic_txrx.c",
      "drivers/net/ethernet/qlogic/qed/qed_mng_tlv.c",
      "drivers/net/ethernet/wangxun/libwx/wx_lib.c",
      "drivers/net/usb/qmi_wwan.c",
      "drivers/net/wireless/intel/iwlegacy/4965-rs.c",
      "drivers/net/wireless/intel/iwlwifi/mvm/mld-mac.c",
      "include/net/bluetooth/hci_core.h",
      "include/uapi/linux/mptcp_pm.h",
      "include/uapi/linux/vm_sockets.h",
      "net/atm/clip.c",
      "net/atm/resources.c",
      "net/bluetooth/hci_core.c",
      "net/bluetooth/l2cap_core.c",
      "net/bridge/br_multicast.c",
      "net/core/netpoll.c",
      "net/core/selftests.c",
      "net/mac80211/link.c",
      "net/mac80211/util.c",
      "net/unix/af_unix.c",
      "tools/testing/selftests/net/af_unix/msg_oob.c"
    ],
    "diff": "diff --git a/CREDITS b/CREDITS\nindex 45446ae322ec..c30b75f9a732 100644\n--- a/CREDITS\n+++ b/CREDITS\n@@ -2981,6 +2981,11 @@ S: 521 Pleasant Valley Road\n S: Potsdam, New York 13676\n S: USA\n \n+N: Shannon Nelson\n+E: sln@onemain.com\n+D: Worked on several network drivers including\n+D: ixgbe, i40e, ionic, pds_core, pds_vdpa, pds_fwctl\n+\n N: Dave Neuer\n E: dave.neuer@pobox.com\n D: Helped implement support for Compaq's H31xx series iPAQs\ndiff --git a/Documentation/netlink/genetlink-legacy.yaml b/Documentation/netlink/genetlink-legacy.yaml\nindex 4cbfe666e6f5..b29d62eefa16 100644\n--- a/Documentation/netlink/genetlink-legacy.yaml\n+++ b/Documentation/netlink/genetlink-legacy.yaml\n@@ -6,6 +6,9 @@ $schema: https://json-schema.org/draft-07/schema\n \n # Common defines\n $defs:\n+  name:\n+    type: string\n+    pattern: ^[0-9a-z-]+$\n   uint:\n     type: integer\n     minimum: 0\n@@ -76,7 +79,7 @@ properties:\n       additionalProperties: False\n       properties:\n         name:\n-          type: string\n+          $ref: '#/$defs/name'\n         header:\n           description: For C-compatible languages, header which already defines this value.\n           type: string\n@@ -103,7 +106,7 @@ properties:\n                 additionalProperties: False\n                 properties:\n                   name:\n-                    type: string\n+                    $ref: '#/$defs/name'\n                   value:\n                     type: integer\n                   doc:\n@@ -132,7 +135,7 @@ properties:\n             additionalProperties: False\n             properties:\n               name:\n-                type: string\n+                $ref: '#/$defs/name'\n               type:\n                 description: The netlink attribute type\n                 enum: [ u8, u16, u32, u64, s8, s16, s32, s64, string, binary ]\n@@ -169,7 +172,7 @@ properties:\n         name:\n           description: |\n             Name used when referring to this space in other definitions, not used outside of the spec.\n-          type: string\n+          $ref: '#/$defs/name'\n         name-prefix:\n           description: |\n             Prefix for the C enum name of the attributes. Default family[name]-set[name]-a-\n@@ -206,7 +209,7 @@ properties:\n             additionalProperties: False\n             properties:\n               name:\n-                type: string\n+                $ref: '#/$defs/name'\n               type: &attr-type\n                 description: The netlink attribute type\n                 enum: [ unused, pad, flag, binary, bitfield32,\n@@ -348,7 +351,7 @@ properties:\n           properties:\n             name:\n               description: Name of the operation, also defining its C enum value in uAPI.\n-              type: string\n+              $ref: '#/$defs/name'\n             doc:\n               description: Documentation for the command.\n               type: string\ndiff --git a/Documentation/netlink/genetlink.yaml b/Documentation/netlink/genetlink.yaml\nindex 40efbbad76ab..7b1ec153e834 100644\n--- a/Documentation/netlink/genetlink.yaml\n+++ b/Documentation/netlink/genetlink.yaml\n@@ -6,6 +6,9 @@ $schema: https://json-schema.org/draft-07/schema\n \n # Common defines\n $defs:\n+  name:\n+    type: string\n+    pattern: ^[0-9a-z-]+$\n   uint:\n     type: integer\n     minimum: 0\n@@ -29,7 +32,7 @@ additionalProperties: False\n properties:\n   name:\n     description: Name of the genetlink family.\n-    type: string\n+    $ref: '#/$defs/name'\n   doc:\n     type: string\n   protocol:\n@@ -48,7 +51,7 @@ properties:\n       additionalProperties: False\n       properties:\n         name:\n-          type: string\n+          $ref: '#/$defs/name'\n         header:\n           description: For C-compatible languages, header which already defines this value.\n           type: string\n@@ -75,7 +78,7 @@ properties:\n                 additionalProperties: False\n                 properties:\n                   name:\n-                    type: string\n+                    $ref: '#/$defs/name'\n                   value:\n                     type: integer\n                   doc:\n@@ -96,7 +99,7 @@ properties:\n         name:\n           description: |\n             Name used when referring to this space in other definitions, not used outside of the spec.\n-          type: string\n+          $ref: '#/$defs/name'\n         name-prefix:\n           description: |\n             Prefix for the C enum name of the attributes. Default family[name]-set[name]-a-\n@@ -121,7 +124,7 @@ properties:\n             additionalProperties: False\n             properties:\n               name:\n-                type: string\n+                $ref: '#/$defs/name'\n               type: &attr-type\n                 enum: [ unused, pad, flag, binary,\n                         uint, sint, u8, u16, u32, u64, s8, s16, s32, s64,\n@@ -243,7 +246,7 @@ properties:\n           properties:\n             name:\n               description: Name of the operation, also defining its C enum value in uAPI.\n-              type: string\n+              $ref: '#/$defs/name'\n             doc:\n               description: Documentation for the command.\n               type: string\n@@ -327,7 +330,7 @@ properties:\n             name:\n               description: |\n                 The name for the group, used to form the define and the value of the define.\n-              type: string\n+              $ref: '#/$defs/name'\n             flags: *cmd_flags\n \n   kernel-family:\ndiff --git a/Documentation/netlink/netlink-raw.yaml b/Documentation/netlink/netlink-raw.yaml\nindex e34bf23897fa..246fa07bccf6 100644\n--- a/Documentation/netlink/netlink-raw.yaml\n+++ b/Documentation/netlink/netlink-raw.yaml\n@@ -6,6 +6,12 @@ $schema: https://json-schema.org/draft-07/schema\n \n # Common defines\n $defs:\n+  name:\n+    type: string\n+    pattern: ^[0-9a-z-]+$\n+  name-cap:\n+    type: string\n+    pattern: ^[0-9a-zA-Z-]+$\n   uint:\n     type: integer\n     minimum: 0\n@@ -71,7 +77,7 @@ properties:\n       additionalProperties: False\n       properties:\n         name:\n-          type: string\n+          $ref: '#/$defs/name'\n         header:\n           description: For C-compatible languages, header which already defines this value.\n           type: string\n@@ -98,7 +104,7 @@ properties:\n                 additionalProperties: False\n                 properties:\n                   name:\n-                    type: string\n+                    $ref: '#/$defs/name'\n                   value:\n                     type: integer\n                   doc:\n@@ -124,7 +130,7 @@ properties:\n             additionalProperties: False\n             properties:\n               name:\n-                type: string\n+                $ref: '#/$defs/name-cap'\n               type:\n                 description: |\n                   The netlink attribute type. Members of type 'binary' or 'pad'\n@@ -183,7 +189,7 @@ properties:\n         name:\n           description: |\n             Name used when referring to this space in other definitions, not used outside of the spec.\n-          type: string\n+          $ref: '#/$defs/name'\n         name-prefix:\n           description: |\n             Prefix for the C enum name of the attributes. Default family[name]-set[name]-a-\n@@ -220,7 +226,7 @@ properties:\n             additionalProperties: False\n             properties:\n               name:\n-                type: string\n+                $ref: '#/$defs/name'\n               type: &attr-type\n                 description: The netlink attribute type\n                 enum: [ unused, pad, flag, binary, bitfield32,\n@@ -408,7 +414,7 @@ properties:\n           properties:\n             name:\n               description: Name of the operation, also defining its C enum value in uAPI.\n-              type: string\n+              $ref: '#/$defs/name'\n             doc:\n               description: Documentation for the command.\n               type: string\ndiff --git a/Documentation/netlink/specs/devlink.yaml b/Documentation/netlink/specs/devlink.yaml\nindex 05fee1b7fe19..38ddc04f9e6d 100644\n--- a/Documentation/netlink/specs/devlink.yaml\n+++ b/Documentation/netlink/specs/devlink.yaml\n@@ -38,15 +38,15 @@ definitions:\n       -\n         name: dsa\n       -\n-        name: pci_pf\n+        name: pci-pf\n       -\n-        name: pci_vf\n+        name: pci-vf\n       -\n         name: virtual\n       -\n         name: unused\n       -\n-        name: pci_sf\n+        name: pci-sf\n   -\n     type: enum\n     name: port-fn-state\n@@ -220,7 +220,7 @@ definitions:\n       -\n         name: flag\n       -\n-        name: nul_string\n+        name: nul-string\n         value: 10\n       -\n         name: binary\ndiff --git a/Documentation/netlink/specs/dpll.yaml b/Documentation/netlink/specs/dpll.yaml\nindex 8feefeae5376..f434140b538e 100644\n--- a/Documentation/netlink/specs/dpll.yaml\n+++ b/Documentation/netlink/specs/dpll.yaml\n@@ -188,7 +188,7 @@ definitions:\n     value: 10000\n   -\n     type: const\n-    name: pin-frequency-77_5-khz\n+    name: pin-frequency-77-5-khz\n     value: 77500\n   -\n     type: const\ndiff --git a/Documentation/netlink/specs/ethtool.yaml b/Documentation/netlink/specs/ethtool.yaml\nindex 72a076b0e1b5..348c6ad548f5 100644\n--- a/Documentation/netlink/specs/ethtool.yaml\n+++ b/Documentation/netlink/specs/ethtool.yaml\n@@ -48,7 +48,7 @@ definitions:\n         name: started\n         doc: The firmware flashing process has started.\n       -\n-        name: in_progress\n+        name: in-progress\n         doc: The firmware flashing process is in progress.\n       -\n         name: completed\n@@ -1422,7 +1422,7 @@ attribute-sets:\n         name: hkey\n         type: binary\n       -\n-        name: input_xfrm\n+        name: input-xfrm\n         type: u32\n       -\n         name: start-context\n@@ -2238,7 +2238,7 @@ operations:\n             - hfunc\n             - indir\n             - hkey\n-            - input_xfrm\n+            - input-xfrm\n       dump:\n         request:\n           attributes:\ndiff --git a/Documentation/netlink/specs/fou.yaml b/Documentation/netlink/specs/fou.yaml\nindex 0af5ab842c04..b02ab19817d3 100644\n--- a/Documentation/netlink/specs/fou.yaml\n+++ b/Documentation/netlink/specs/fou.yaml\n@@ -15,7 +15,7 @@ kernel-policy: global\n definitions:\n   -\n     type: enum\n-    name: encap_type\n+    name: encap-type\n     name-prefix: fou-encap-\n     enum-name:\n     entries: [ unspec, direct, gue ]\n@@ -43,26 +43,26 @@ attribute-sets:\n         name: type\n         type: u8\n       -\n-        name: remcsum_nopartial\n+        name: remcsum-nopartial\n         type: flag\n       -\n-        name: local_v4\n+        name: local-v4\n         type: u32\n       -\n-        name: local_v6\n+        name: local-v6\n         type: binary\n         checks:\n           min-len: 16\n       -\n-        name: peer_v4\n+        name: peer-v4\n         type: u32\n       -\n-        name: peer_v6\n+        name: peer-v6\n         type: binary\n         checks:\n           min-len: 16\n       -\n-        name: peer_port\n+        name: peer-port\n         type: u16\n         byte-order: big-endian\n       -\n@@ -90,12 +90,12 @@ operations:\n             - port\n             - ipproto\n             - type\n-            - remcsum_nopartial\n-            - local_v4\n-            - peer_v4\n-            - local_v6\n-            - peer_v6\n-            - peer_port\n+            - remcsum-nopartial\n+            - local-v4\n+            - peer-v4\n+            - local-v6\n+            - peer-v6\n+            - peer-port\n             - ifindex\n \n     -\n@@ -112,11 +112,11 @@ operations:\n             - af\n             - ifindex\n             - port\n-            - peer_port\n-            - local_v4\n-            - peer_v4\n-            - local_v6\n-            - peer_v6\n+            - peer-port\n+            - local-v4\n+            - peer-v4\n+            - local-v6\n+            - peer-v6\n \n     -\n       name: get\ndiff --git a/Documentation/netlink/specs/mptcp_pm.yaml b/Documentation/netlink/specs/mptcp_pm.yaml\nindex dfd017780d2f..fb57860fe778 100644\n--- a/Documentation/netlink/specs/mptcp_pm.yaml\n+++ b/Documentation/netlink/specs/mptcp_pm.yaml\n@@ -57,21 +57,21 @@ definitions:\n       doc: >-\n         A new subflow has been established. 'error' should not be set.\n         Attributes: token, family, loc_id, rem_id, saddr4 | saddr6, daddr4 |\n-        daddr6, sport, dport, backup, if_idx [, error].\n+        daddr6, sport, dport, backup, if-idx [, error].\n      -\n       name: sub-closed\n       doc: >-\n         A subflow has been closed. An error (copy of sk_err) could be set if an\n         error has been detected for this subflow.\n         Attributes: token, family, loc_id, rem_id, saddr4 | saddr6, daddr4 |\n-        daddr6, sport, dport, backup, if_idx [, error].\n+        daddr6, sport, dport, backup, if-idx [, error].\n      -\n       name: sub-priority\n       value: 13\n       doc: >-\n         The priority of a subflow has changed. 'error' should not be set.\n         Attributes: token, family, loc_id, rem_id, saddr4 | saddr6, daddr4 |\n-        daddr6, sport, dport, backup, if_idx [, error].\n+        daddr6, sport, dport, backup, if-idx [, error].\n      -\n       name: listener-created\n       value: 15\n@@ -255,7 +255,7 @@ attribute-sets:\n         name: timeout\n         type: u32\n       -\n-        name: if_idx\n+        name: if-idx\n         type: u32\n       -\n         name: reset-reason\ndiff --git a/Documentation/netlink/specs/nfsd.yaml b/Documentation/netlink/specs/nfsd.yaml\nindex c87658114852..8d1a3c01708f 100644\n--- a/Documentation/netlink/specs/nfsd.yaml\n+++ b/Documentation/netlink/specs/nfsd.yaml\n@@ -27,7 +27,7 @@ attribute-sets:\n         name: proc\n         type: u32\n       -\n-        name: service_time\n+        name: service-time\n         type: s64\n       -\n         name: pad\n@@ -139,7 +139,7 @@ operations:\n             - prog\n             - version\n             - proc\n-            - service_time\n+            - service-time\n             - saddr4\n             - daddr4\n             - saddr6\ndiff --git a/Documentation/netlink/specs/ovs_flow.yaml b/Documentation/netlink/specs/ovs_flow.yaml\nindex 46f5d1cd8a5f..7974aa7d8905 100644\n--- a/Documentation/netlink/specs/ovs_flow.yaml\n+++ b/Documentation/netlink/specs/ovs_flow.yaml\n@@ -216,7 +216,7 @@ definitions:\n     type: struct\n     members:\n       -\n-        name: nd_target\n+        name: nd-target\n         type: binary\n         len: 16\n         byte-order: big-endian\n@@ -258,12 +258,12 @@ definitions:\n     type: struct\n     members:\n       -\n-        name: vlan_tpid\n+        name: vlan-tpid\n         type: u16\n         byte-order: big-endian\n         doc: Tag protocol identifier (TPID) to push.\n       -\n-        name: vlan_tci\n+        name: vlan-tci\n         type: u16\n         byte-order: big-endian\n         doc: Tag control identifier (TCI) to push.\ndiff --git a/Documentation/netlink/specs/rt-link.yaml b/Documentation/netlink/specs/rt-link.yaml\nindex b41b31eebcae..28c4cf66517c 100644\n--- a/Documentation/netlink/specs/rt-link.yaml\n+++ b/Documentation/netlink/specs/rt-link.yaml\n@@ -603,7 +603,7 @@ definitions:\n         name: optmask\n         type: u32\n   -\n-    name: if_stats_msg\n+    name: if-stats-msg\n     type: struct\n     members:\n       -\n@@ -2486,7 +2486,7 @@ operations:\n       name: getstats\n       doc: Get / dump link stats.\n       attribute-set: stats-attrs\n-      fixed-header: if_stats_msg\n+      fixed-header: if-stats-msg\n       do:\n         request:\n           value: 94\ndiff --git a/Documentation/netlink/specs/tc.yaml b/Documentation/netlink/specs/tc.yaml\nindex cb7ea7d62e56..42d74c9aeb54 100644\n--- a/Documentation/netlink/specs/tc.yaml\n+++ b/Documentation/netlink/specs/tc.yaml\n@@ -232,7 +232,7 @@ definitions:\n         type: u8\n         doc: log(P_max / (qth-max - qth-min))\n       -\n-        name: Scell_log\n+        name: Scell-log\n         type: u8\n         doc: cell size for idle damping\n       -\n@@ -253,7 +253,7 @@ definitions:\n         name: DPs\n         type: u32\n       -\n-        name: def_DP\n+        name: def-DP\n         type: u32\n       -\n         name: grio\ndiff --git a/Documentation/networking/device_drivers/ethernet/marvell/octeontx2.rst b/Documentation/networking/device_drivers/ethernet/marvell/octeontx2.rst\nindex af7db0e91f6b..a52850602cd8 100644\n--- a/Documentation/networking/device_drivers/ethernet/marvell/octeontx2.rst\n+++ b/Documentation/networking/device_drivers/ethernet/marvell/octeontx2.rst\n@@ -66,7 +66,7 @@ Admin Function driver\n As mentioned above RVU PF0 is called the admin function (AF), this driver\n supports resource provisioning and configuration of functional blocks.\n Doesn't handle any I/O. It sets up few basic stuff but most of the\n-funcionality is achieved via configuration requests from PFs and VFs.\n+functionality is achieved via configuration requests from PFs and VFs.\n \n PF/VFs communicates with AF via a shared memory region (mailbox). Upon\n receiving requests AF does resource provisioning and other HW configuration.\ndiff --git a/drivers/atm/idt77252.c b/drivers/atm/idt77252.c\nindex 1206ab764ba9..f2e91b7d79f0 100644\n--- a/drivers/atm/idt77252.c\n+++ b/drivers/atm/idt77252.c\n@@ -852,6 +852,8 @@ queue_skb(struct idt77252_dev *card, struct vc_map *vc,\n \n \tIDT77252_PRV_PADDR(skb) = dma_map_single(&card->pcidev->dev, skb->data,\n \t\t\t\t\t\t skb->len, DMA_TO_DEVICE);\n+\tif (dma_mapping_error(&card->pcidev->dev, IDT77252_PRV_PADDR(skb)))\n+\t\treturn -ENOMEM;\n \n \terror = -EINVAL;\n \n@@ -1857,6 +1859,8 @@ add_rx_skb(struct idt77252_dev *card, int queue,\n \t\tpaddr = dma_map_single(&card->pcidev->dev, skb->data,\n \t\t\t\t       skb_end_pointer(skb) - skb->data,\n \t\t\t\t       DMA_FROM_DEVICE);\n+\t\tif (dma_mapping_error(&card->pcidev->dev, paddr))\n+\t\t\tgoto outpoolrm;\n \t\tIDT77252_PRV_PADDR(skb) = paddr;\n \n \t\tif (push_rx_skb(card, skb, queue)) {\n@@ -1871,6 +1875,7 @@ add_rx_skb(struct idt77252_dev *card, int queue,\n \tdma_unmap_single(&card->pcidev->dev, IDT77252_PRV_PADDR(skb),\n \t\t\t skb_end_pointer(skb) - skb->data, DMA_FROM_DEVICE);\n \n+outpoolrm:\n \thandle = IDT77252_PRV_POOL(skb);\n \tcard->sbpool[POOL_QUEUE(handle)].skb[POOL_INDEX(handle)] = NULL;\n \ndiff --git a/drivers/bluetooth/btintel_pcie.c b/drivers/bluetooth/btintel_pcie.c\nindex 563165c5efae..e1c688dd2d45 100644\n--- a/drivers/bluetooth/btintel_pcie.c\n+++ b/drivers/bluetooth/btintel_pcie.c\n@@ -2033,6 +2033,28 @@ static void btintel_pcie_release_hdev(struct btintel_pcie_data *data)\n \tdata->hdev = NULL;\n }\n \n+static void btintel_pcie_disable_interrupts(struct btintel_pcie_data *data)\n+{\n+\tspin_lock(&data->irq_lock);\n+\tbtintel_pcie_wr_reg32(data, BTINTEL_PCIE_CSR_MSIX_FH_INT_MASK, data->fh_init_mask);\n+\tbtintel_pcie_wr_reg32(data, BTINTEL_PCIE_CSR_MSIX_HW_INT_MASK, data->hw_init_mask);\n+\tspin_unlock(&data->irq_lock);\n+}\n+\n+static void btintel_pcie_enable_interrupts(struct btintel_pcie_data *data)\n+{\n+\tspin_lock(&data->irq_lock);\n+\tbtintel_pcie_wr_reg32(data, BTINTEL_PCIE_CSR_MSIX_FH_INT_MASK, ~data->fh_init_mask);\n+\tbtintel_pcie_wr_reg32(data, BTINTEL_PCIE_CSR_MSIX_HW_INT_MASK, ~data->hw_init_mask);\n+\tspin_unlock(&data->irq_lock);\n+}\n+\n+static void btintel_pcie_synchronize_irqs(struct btintel_pcie_data *data)\n+{\n+\tfor (int i = 0; i < data->alloc_vecs; i++)\n+\t\tsynchronize_irq(data->msix_entries[i].vector);\n+}\n+\n static int btintel_pcie_setup_internal(struct hci_dev *hdev)\n {\n \tstruct btintel_pcie_data *data = hci_get_drvdata(hdev);\n@@ -2152,6 +2174,8 @@ static int btintel_pcie_setup(struct hci_dev *hdev)\n \t\tbt_dev_err(hdev, \"Firmware download retry count: %d\",\n \t\t\t   fw_dl_retry);\n \t\tbtintel_pcie_dump_debug_registers(hdev);\n+\t\tbtintel_pcie_disable_interrupts(data);\n+\t\tbtintel_pcie_synchronize_irqs(data);\n \t\terr = btintel_pcie_reset_bt(data);\n \t\tif (err) {\n \t\t\tbt_dev_err(hdev, \"Failed to do shr reset: %d\", err);\n@@ -2159,6 +2183,7 @@ static int btintel_pcie_setup(struct hci_dev *hdev)\n \t\t}\n \t\tusleep_range(10000, 12000);\n \t\tbtintel_pcie_reset_ia(data);\n+\t\tbtintel_pcie_enable_interrupts(data);\n \t\tbtintel_pcie_config_msix(data);\n \t\terr = btintel_pcie_enable_bt(data);\n \t\tif (err) {\n@@ -2291,6 +2316,12 @@ static void btintel_pcie_remove(struct pci_dev *pdev)\n \n \tdata = pci_get_drvdata(pdev);\n \n+\tbtintel_pcie_disable_interrupts(data);\n+\n+\tbtintel_pcie_synchronize_irqs(data);\n+\n+\tflush_work(&data->rx_work);\n+\n \tbtintel_pcie_reset_bt(data);\n \tfor (int i = 0; i < data->alloc_vecs; i++) {\n \t\tstruct msix_entry *msix_entry;\n@@ -2303,8 +2334,6 @@ static void btintel_pcie_remove(struct pci_dev *pdev)\n \n \tbtintel_pcie_release_hdev(data);\n \n-\tflush_work(&data->rx_work);\n-\n \tdestroy_workqueue(data->workqueue);\n \n \tbtintel_pcie_free(data);\ndiff --git a/drivers/bluetooth/hci_qca.c b/drivers/bluetooth/hci_qca.c\nindex 5fe5879881f5..3ec0be496820 100644\n--- a/drivers/bluetooth/hci_qca.c\n+++ b/drivers/bluetooth/hci_qca.c\n@@ -2392,10 +2392,17 @@ static int qca_serdev_probe(struct serdev_device *serdev)\n \t\t\t */\n \t\t\tqcadev->bt_power->pwrseq = devm_pwrseq_get(&serdev->dev,\n \t\t\t\t\t\t\t\t   \"bluetooth\");\n-\t\t\tif (IS_ERR(qcadev->bt_power->pwrseq))\n-\t\t\t\treturn PTR_ERR(qcadev->bt_power->pwrseq);\n \n-\t\t\tbreak;\n+\t\t\t/*\n+\t\t\t * Some modules have BT_EN enabled via a hardware pull-up,\n+\t\t\t * meaning it is not defined in the DTS and is not controlled\n+\t\t\t * through the power sequence. In such cases, fall through\n+\t\t\t * to follow the legacy flow.\n+\t\t\t */\n+\t\t\tif (IS_ERR(qcadev->bt_power->pwrseq))\n+\t\t\t\tqcadev->bt_power->pwrseq = NULL;\n+\t\t\telse\n+\t\t\t\tbreak;\n \t\t}\n \t\tfallthrough;\n \tcase QCA_WCN3950:\ndiff --git a/drivers/net/ethernet/broadcom/bnxt/bnxt.c b/drivers/net/ethernet/broadcom/bnxt/bnxt.c\nindex 2cb3185c442c..ae89a981e052 100644\n--- a/drivers/net/ethernet/broadcom/bnxt/bnxt.c\n+++ b/drivers/net/ethernet/broadcom/bnxt/bnxt.c\n@@ -2989,6 +2989,7 @@ static int __bnxt_poll_work(struct bnxt *bp, struct bnxt_cp_ring_info *cpr,\n {\n \tstruct bnxt_napi *bnapi = cpr->bnapi;\n \tu32 raw_cons = cpr->cp_raw_cons;\n+\tbool flush_xdp = false;\n \tu32 cons;\n \tint rx_pkts = 0;\n \tu8 event = 0;\n@@ -3042,6 +3043,8 @@ static int __bnxt_poll_work(struct bnxt *bp, struct bnxt_cp_ring_info *cpr,\n \t\t\telse\n \t\t\t\trc = bnxt_force_rx_discard(bp, cpr, &raw_cons,\n \t\t\t\t\t\t\t   &event);\n+\t\t\tif (event & BNXT_REDIRECT_EVENT)\n+\t\t\t\tflush_xdp = true;\n \t\t\tif (likely(rc >= 0))\n \t\t\t\trx_pkts += rc;\n \t\t\t/* Increment rx_pkts when rc is -ENOMEM to count towards\n@@ -3066,7 +3069,7 @@ static int __bnxt_poll_work(struct bnxt *bp, struct bnxt_cp_ring_info *cpr,\n \t\t}\n \t}\n \n-\tif (event & BNXT_REDIRECT_EVENT) {\n+\tif (flush_xdp) {\n \t\txdp_do_flush();\n \t\tevent &= ~BNXT_REDIRECT_EVENT;\n \t}\ndiff --git a/drivers/net/ethernet/freescale/enetc/enetc_hw.h b/drivers/net/ethernet/freescale/enetc/enetc_hw.h\nindex 4098f01479bc..53e8d18c7a34 100644\n--- a/drivers/net/ethernet/freescale/enetc/enetc_hw.h\n+++ b/drivers/net/ethernet/freescale/enetc/enetc_hw.h\n@@ -507,7 +507,7 @@ static inline u64 _enetc_rd_reg64(void __iomem *reg)\n \t\ttmp = ioread32(reg + 4);\n \t} while (high != tmp);\n \n-\treturn le64_to_cpu((__le64)high << 32 | low);\n+\treturn (u64)high << 32 | low;\n }\n #endif\n \ndiff --git a/drivers/net/ethernet/microsoft/mana/gdma_main.c b/drivers/net/ethernet/microsoft/mana/gdma_main.c\nindex 3504507477c6..52cf7112762c 100644\n--- a/drivers/net/ethernet/microsoft/mana/gdma_main.c\n+++ b/drivers/net/ethernet/microsoft/mana/gdma_main.c\n@@ -31,6 +31,9 @@ static void mana_gd_init_pf_regs(struct pci_dev *pdev)\n \tgc->db_page_base = gc->bar0_va +\n \t\t\t\tmana_gd_r64(gc, GDMA_PF_REG_DB_PAGE_OFF);\n \n+\tgc->phys_db_page_base = gc->bar0_pa +\n+\t\t\t\tmana_gd_r64(gc, GDMA_PF_REG_DB_PAGE_OFF);\n+\n \tsriov_base_off = mana_gd_r64(gc, GDMA_SRIOV_REG_CFG_BASE_OFF);\n \n \tsriov_base_va = gc->bar0_va + sriov_base_off;\ndiff --git a/drivers/net/ethernet/pensando/ionic/ionic_txrx.c b/drivers/net/ethernet/pensando/ionic/ionic_txrx.c\nindex 2ac59564ded1..d10b58ebf603 100644\n--- a/drivers/net/ethernet/pensando/ionic/ionic_txrx.c\n+++ b/drivers/net/ethernet/pensando/ionic/ionic_txrx.c\n@@ -321,7 +321,7 @@ static int ionic_xdp_post_frame(struct ionic_queue *q, struct xdp_frame *frame,\n \t\t\t\t\t   len, DMA_TO_DEVICE);\n \t} else /* XDP_REDIRECT */ {\n \t\tdma_addr = ionic_tx_map_single(q, frame->data, len);\n-\t\tif (!dma_addr)\n+\t\tif (dma_addr == DMA_MAPPING_ERROR)\n \t\t\treturn -EIO;\n \t}\n \n@@ -357,7 +357,7 @@ static int ionic_xdp_post_frame(struct ionic_queue *q, struct xdp_frame *frame,\n \t\t\t} else {\n \t\t\t\tdma_addr = ionic_tx_map_frag(q, frag, 0,\n \t\t\t\t\t\t\t     skb_frag_size(frag));\n-\t\t\t\tif (dma_mapping_error(q->dev, dma_addr)) {\n+\t\t\t\tif (dma_addr == DMA_MAPPING_ERROR) {\n \t\t\t\t\tionic_tx_desc_unmap_bufs(q, desc_info);\n \t\t\t\t\treturn -EIO;\n \t\t\t\t}\n@@ -1083,7 +1083,7 @@ static dma_addr_t ionic_tx_map_single(struct ionic_queue *q,\n \t\tnet_warn_ratelimited(\"%s: DMA single map failed on %s!\\n\",\n \t\t\t\t     dev_name(dev), q->name);\n \t\tq_to_tx_stats(q)->dma_map_err++;\n-\t\treturn 0;\n+\t\treturn DMA_MAPPING_ERROR;\n \t}\n \treturn dma_addr;\n }\n@@ -1100,7 +1100,7 @@ static dma_addr_t ionic_tx_map_frag(struct ionic_queue *q,\n \t\tnet_warn_ratelimited(\"%s: DMA frag map failed on %s!\\n\",\n \t\t\t\t     dev_name(dev), q->name);\n \t\tq_to_tx_stats(q)->dma_map_err++;\n-\t\treturn 0;\n+\t\treturn DMA_MAPPING_ERROR;\n \t}\n \treturn dma_addr;\n }\n@@ -1116,7 +1116,7 @@ static int ionic_tx_map_skb(struct ionic_queue *q, struct sk_buff *skb,\n \tint frag_idx;\n \n \tdma_addr = ionic_tx_map_single(q, skb->data, skb_headlen(skb));\n-\tif (!dma_addr)\n+\tif (dma_addr == DMA_MAPPING_ERROR)\n \t\treturn -EIO;\n \tbuf_info->dma_addr = dma_addr;\n \tbuf_info->len = skb_headlen(skb);\n@@ -1126,7 +1126,7 @@ static int ionic_tx_map_skb(struct ionic_queue *q, struct sk_buff *skb,\n \tnfrags = skb_shinfo(skb)->nr_frags;\n \tfor (frag_idx = 0; frag_idx < nfrags; frag_idx++, frag++) {\n \t\tdma_addr = ionic_tx_map_frag(q, frag, 0, skb_frag_size(frag));\n-\t\tif (!dma_addr)\n+\t\tif (dma_addr == DMA_MAPPING_ERROR)\n \t\t\tgoto dma_fail;\n \t\tbuf_info->dma_addr = dma_addr;\n \t\tbuf_info->len = skb_frag_size(frag);\ndiff --git a/drivers/net/ethernet/qlogic/qed/qed_mng_tlv.c b/drivers/net/ethernet/qlogic/qed/qed_mng_tlv.c\nindex f55eed092f25..7d78f072b0a1 100644\n--- a/drivers/net/ethernet/qlogic/qed/qed_mng_tlv.c\n+++ b/drivers/net/ethernet/qlogic/qed/qed_mng_tlv.c\n@@ -242,7 +242,7 @@ static int qed_mfw_get_tlv_group(u8 tlv_type, u8 *tlv_group)\n }\n \n /* Returns size of the data buffer or, -1 in case TLV data is not available. */\n-static int\n+static noinline_for_stack int\n qed_mfw_get_gen_tlv_value(struct qed_drv_tlv_hdr *p_tlv,\n \t\t\t  struct qed_mfw_tlv_generic *p_drv_buf,\n \t\t\t  struct qed_tlv_parsed_buf *p_buf)\n@@ -304,7 +304,7 @@ qed_mfw_get_gen_tlv_value(struct qed_drv_tlv_hdr *p_tlv,\n \treturn -1;\n }\n \n-static int\n+static noinline_for_stack int\n qed_mfw_get_eth_tlv_value(struct qed_drv_tlv_hdr *p_tlv,\n \t\t\t  struct qed_mfw_tlv_eth *p_drv_buf,\n \t\t\t  struct qed_tlv_parsed_buf *p_buf)\n@@ -438,7 +438,7 @@ qed_mfw_get_tlv_time_value(struct qed_mfw_tlv_time *p_time,\n \treturn QED_MFW_TLV_TIME_SIZE;\n }\n \n-static int\n+static noinline_for_stack int\n qed_mfw_get_fcoe_tlv_value(struct qed_drv_tlv_hdr *p_tlv,\n \t\t\t   struct qed_mfw_tlv_fcoe *p_drv_buf,\n \t\t\t   struct qed_tlv_parsed_buf *p_buf)\n@@ -1073,7 +1073,7 @@ qed_mfw_get_fcoe_tlv_value(struct qed_drv_tlv_hdr *p_tlv,\n \treturn -1;\n }\n \n-static int\n+static noinline_for_stack int\n qed_mfw_get_iscsi_tlv_value(struct qed_drv_tlv_hdr *p_tlv,\n \t\t\t    struct qed_mfw_tlv_iscsi *p_drv_buf,\n \t\t\t    struct qed_tlv_parsed_buf *p_buf)\ndiff --git a/drivers/net/ethernet/wangxun/libwx/wx_lib.c b/drivers/net/ethernet/wangxun/libwx/wx_lib.c\nindex 7f2e6cddfeb1..c57cc4f27249 100644\n--- a/drivers/net/ethernet/wangxun/libwx/wx_lib.c\n+++ b/drivers/net/ethernet/wangxun/libwx/wx_lib.c\n@@ -2623,7 +2623,7 @@ static int wx_alloc_page_pool(struct wx_ring *rx_ring)\n \tstruct page_pool_params pp_params = {\n \t\t.flags = PP_FLAG_DMA_MAP | PP_FLAG_DMA_SYNC_DEV,\n \t\t.order = 0,\n-\t\t.pool_size = rx_ring->size,\n+\t\t.pool_size = rx_ring->count,\n \t\t.nid = dev_to_node(rx_ring->dev),\n \t\t.dev = rx_ring->dev,\n \t\t.dma_dir = DMA_FROM_DEVICE,\ndiff --git a/drivers/net/usb/qmi_wwan.c b/drivers/net/usb/qmi_wwan.c\nindex b586b1c13a47..f5647ee0adde 100644\n--- a/drivers/net/usb/qmi_wwan.c\n+++ b/drivers/net/usb/qmi_wwan.c\n@@ -1426,6 +1426,7 @@ static const struct usb_device_id products[] = {\n \t{QMI_QUIRK_SET_DTR(0x22de, 0x9051, 2)}, /* Hucom Wireless HM-211S/K */\n \t{QMI_FIXED_INTF(0x22de, 0x9061, 3)},\t/* WeTelecom WPD-600N */\n \t{QMI_QUIRK_SET_DTR(0x1e0e, 0x9001, 5)},\t/* SIMCom 7100E, 7230E, 7600E ++ */\n+\t{QMI_QUIRK_SET_DTR(0x1e0e, 0x9071, 3)},\t/* SIMCom 8230C ++ */\n \t{QMI_QUIRK_SET_DTR(0x2c7c, 0x0121, 4)},\t/* Quectel EC21 Mini PCIe */\n \t{QMI_QUIRK_SET_DTR(0x2c7c, 0x0191, 4)},\t/* Quectel EG91 */\n \t{QMI_QUIRK_SET_DTR(0x2c7c, 0x0195, 4)},\t/* Quectel EG95 */\ndiff --git a/drivers/net/wireless/intel/iwlegacy/4965-rs.c b/drivers/net/wireless/intel/iwlegacy/4965-rs.c\nindex 0e5130d1fccd..031d88bf6393 100644\n--- a/drivers/net/wireless/intel/iwlegacy/4965-rs.c\n+++ b/drivers/net/wireless/intel/iwlegacy/4965-rs.c\n@@ -203,7 +203,8 @@ il4965_rs_extract_rate(u32 rate_n_flags)\n \treturn (u8) (rate_n_flags & 0xFF);\n }\n \n-static void\n+/* noinline works around https://github.com/llvm/llvm-project/issues/143908 */\n+static noinline_for_stack void\n il4965_rs_rate_scale_clear_win(struct il_rate_scale_data *win)\n {\n \twin->data = 0;\ndiff --git a/drivers/net/wireless/intel/iwlwifi/mvm/mld-mac.c b/drivers/net/wireless/intel/iwlwifi/mvm/mld-mac.c\nindex 3c255ae916c8..3f8b840871d3 100644\n--- a/drivers/net/wireless/intel/iwlwifi/mvm/mld-mac.c\n+++ b/drivers/net/wireless/intel/iwlwifi/mvm/mld-mac.c\n@@ -32,9 +32,9 @@ static void iwl_mvm_mld_mac_ctxt_cmd_common(struct iwl_mvm *mvm,\n \tunsigned int link_id;\n \tint cmd_ver = iwl_fw_lookup_cmd_ver(mvm->fw,\n \t\t\t\t\t    WIDE_ID(MAC_CONF_GROUP,\n-\t\t\t\t\t\t    MAC_CONFIG_CMD), 0);\n+\t\t\t\t\t\t    MAC_CONFIG_CMD), 1);\n \n-\tif (WARN_ON(cmd_ver < 1 || cmd_ver > 3))\n+\tif (WARN_ON(cmd_ver > 3))\n \t\treturn;\n \n \tcmd->id_and_color = cpu_to_le32(mvmvif->id);\ndiff --git a/include/net/bluetooth/hci_core.h b/include/net/bluetooth/hci_core.h\nindex a760f05fa3fb..9fc8f544e20e 100644\n--- a/include/net/bluetooth/hci_core.h\n+++ b/include/net/bluetooth/hci_core.h\n@@ -29,6 +29,7 @@\n #include <linux/idr.h>\n #include <linux/leds.h>\n #include <linux/rculist.h>\n+#include <linux/srcu.h>\n \n #include <net/bluetooth/hci.h>\n #include <net/bluetooth/hci_drv.h>\n@@ -347,6 +348,7 @@ struct adv_monitor {\n \n struct hci_dev {\n \tstruct list_head list;\n+\tstruct srcu_struct srcu;\n \tstruct mutex\tlock;\n \n \tstruct ida\tunset_handle_ida;\ndiff --git a/include/uapi/linux/mptcp_pm.h b/include/uapi/linux/mptcp_pm.h\nindex 84fa8a21dfd0..6ac84b2f636c 100644\n--- a/include/uapi/linux/mptcp_pm.h\n+++ b/include/uapi/linux/mptcp_pm.h\n@@ -27,14 +27,14 @@\n  *   token, rem_id.\n  * @MPTCP_EVENT_SUB_ESTABLISHED: A new subflow has been established. 'error'\n  *   should not be set. Attributes: token, family, loc_id, rem_id, saddr4 |\n- *   saddr6, daddr4 | daddr6, sport, dport, backup, if_idx [, error].\n+ *   saddr6, daddr4 | daddr6, sport, dport, backup, if-idx [, error].\n  * @MPTCP_EVENT_SUB_CLOSED: A subflow has been closed. An error (copy of\n  *   sk_err) could be set if an error has been detected for this subflow.\n  *   Attributes: token, family, loc_id, rem_id, saddr4 | saddr6, daddr4 |\n- *   daddr6, sport, dport, backup, if_idx [, error].\n+ *   daddr6, sport, dport, backup, if-idx [, error].\n  * @MPTCP_EVENT_SUB_PRIORITY: The priority of a subflow has changed. 'error'\n  *   should not be set. Attributes: token, family, loc_id, rem_id, saddr4 |\n- *   saddr6, daddr4 | daddr6, sport, dport, backup, if_idx [, error].\n+ *   saddr6, daddr4 | daddr6, sport, dport, backup, if-idx [, error].\n  * @MPTCP_EVENT_LISTENER_CREATED: A new PM listener is created. Attributes:\n  *   family, sport, saddr4 | saddr6.\n  * @MPTCP_EVENT_LISTENER_CLOSED: A PM listener is closed. Attributes: family,\ndiff --git a/include/uapi/linux/vm_sockets.h b/include/uapi/linux/vm_sockets.h\nindex ed07181d4eff..e05280e41522 100644\n--- a/include/uapi/linux/vm_sockets.h\n+++ b/include/uapi/linux/vm_sockets.h\n@@ -17,6 +17,10 @@\n #ifndef _UAPI_VM_SOCKETS_H\n #define _UAPI_VM_SOCKETS_H\n \n+#ifndef __KERNEL__\n+#include <sys/socket.h>        /* for struct sockaddr and sa_family_t */\n+#endif\n+\n #include <linux/socket.h>\n #include <linux/types.h>\n \ndiff --git a/net/atm/clip.c b/net/atm/clip.c\nindex 61b5b700817d..b234dc3bcb0d 100644\n--- a/net/atm/clip.c\n+++ b/net/atm/clip.c\n@@ -193,12 +193,6 @@ static void clip_push(struct atm_vcc *vcc, struct sk_buff *skb)\n \n \tpr_debug(\"\\n\");\n \n-\tif (!clip_devs) {\n-\t\tatm_return(vcc, skb->truesize);\n-\t\tkfree_skb(skb);\n-\t\treturn;\n-\t}\n-\n \tif (!skb) {\n \t\tpr_debug(\"removing VCC %p\\n\", clip_vcc);\n \t\tif (clip_vcc->entry)\n@@ -208,6 +202,11 @@ static void clip_push(struct atm_vcc *vcc, struct sk_buff *skb)\n \t\treturn;\n \t}\n \tatm_return(vcc, skb->truesize);\n+\tif (!clip_devs) {\n+\t\tkfree_skb(skb);\n+\t\treturn;\n+\t}\n+\n \tskb->dev = clip_vcc->entry ? clip_vcc->entry->neigh->dev : clip_devs;\n \t/* clip_vcc->entry == NULL if we don't have an IP address yet */\n \tif (!skb->dev) {\ndiff --git a/net/atm/resources.c b/net/atm/resources.c\nindex 995d29e7fb13..b19d851e1f44 100644\n--- a/net/atm/resources.c\n+++ b/net/atm/resources.c\n@@ -146,11 +146,10 @@ void atm_dev_deregister(struct atm_dev *dev)\n \t */\n \tmutex_lock(&atm_dev_mutex);\n \tlist_del(&dev->dev_list);\n-\tmutex_unlock(&atm_dev_mutex);\n-\n \tatm_dev_release_vccs(dev);\n \tatm_unregister_sysfs(dev);\n \tatm_proc_dev_deregister(dev);\n+\tmutex_unlock(&atm_dev_mutex);\n \n \tatm_dev_put(dev);\n }\ndiff --git a/net/bluetooth/hci_core.c b/net/bluetooth/hci_core.c\nindex 07a8b4281a39..14d7221b8ac0 100644\n--- a/net/bluetooth/hci_core.c\n+++ b/net/bluetooth/hci_core.c\n@@ -64,7 +64,7 @@ static DEFINE_IDA(hci_index_ida);\n \n /* Get HCI device by index.\n  * Device is held on return. */\n-struct hci_dev *hci_dev_get(int index)\n+static struct hci_dev *__hci_dev_get(int index, int *srcu_index)\n {\n \tstruct hci_dev *hdev = NULL, *d;\n \n@@ -77,6 +77,8 @@ struct hci_dev *hci_dev_get(int index)\n \tlist_for_each_entry(d, &hci_dev_list, list) {\n \t\tif (d->id == index) {\n \t\t\thdev = hci_dev_hold(d);\n+\t\t\tif (srcu_index)\n+\t\t\t\t*srcu_index = srcu_read_lock(&d->srcu);\n \t\t\tbreak;\n \t\t}\n \t}\n@@ -84,6 +86,22 @@ struct hci_dev *hci_dev_get(int index)\n \treturn hdev;\n }\n \n+struct hci_dev *hci_dev_get(int index)\n+{\n+\treturn __hci_dev_get(index, NULL);\n+}\n+\n+static struct hci_dev *hci_dev_get_srcu(int index, int *srcu_index)\n+{\n+\treturn __hci_dev_get(index, srcu_index);\n+}\n+\n+static void hci_dev_put_srcu(struct hci_dev *hdev, int srcu_index)\n+{\n+\tsrcu_read_unlock(&hdev->srcu, srcu_index);\n+\thci_dev_put(hdev);\n+}\n+\n /* ---- Inquiry support ---- */\n \n bool hci_discovery_active(struct hci_dev *hdev)\n@@ -568,9 +586,9 @@ static int hci_dev_do_reset(struct hci_dev *hdev)\n int hci_dev_reset(__u16 dev)\n {\n \tstruct hci_dev *hdev;\n-\tint err;\n+\tint err, srcu_index;\n \n-\thdev = hci_dev_get(dev);\n+\thdev = hci_dev_get_srcu(dev, &srcu_index);\n \tif (!hdev)\n \t\treturn -ENODEV;\n \n@@ -592,7 +610,7 @@ int hci_dev_reset(__u16 dev)\n \terr = hci_dev_do_reset(hdev);\n \n done:\n-\thci_dev_put(hdev);\n+\thci_dev_put_srcu(hdev, srcu_index);\n \treturn err;\n }\n \n@@ -2433,6 +2451,11 @@ struct hci_dev *hci_alloc_dev_priv(int sizeof_priv)\n \tif (!hdev)\n \t\treturn NULL;\n \n+\tif (init_srcu_struct(&hdev->srcu)) {\n+\t\tkfree(hdev);\n+\t\treturn NULL;\n+\t}\n+\n \thdev->pkt_type  = (HCI_DM1 | HCI_DH1 | HCI_HV1);\n \thdev->esco_type = (ESCO_HV1);\n \thdev->link_mode = (HCI_LM_ACCEPT);\n@@ -2678,6 +2701,9 @@ void hci_unregister_dev(struct hci_dev *hdev)\n \tlist_del(&hdev->list);\n \twrite_unlock(&hci_dev_list_lock);\n \n+\tsynchronize_srcu(&hdev->srcu);\n+\tcleanup_srcu_struct(&hdev->srcu);\n+\n \tdisable_work_sync(&hdev->rx_work);\n \tdisable_work_sync(&hdev->cmd_work);\n \tdisable_work_sync(&hdev->tx_work);\ndiff --git a/net/bluetooth/l2cap_core.c b/net/bluetooth/l2cap_core.c\nindex a5bde5db58ef..40daa38276f3 100644\n--- a/net/bluetooth/l2cap_core.c\n+++ b/net/bluetooth/l2cap_core.c\n@@ -3415,7 +3415,7 @@ static int l2cap_parse_conf_req(struct l2cap_chan *chan, void *data, size_t data\n \tstruct l2cap_conf_rfc rfc = { .mode = L2CAP_MODE_BASIC };\n \tstruct l2cap_conf_efs efs;\n \tu8 remote_efs = 0;\n-\tu16 mtu = L2CAP_DEFAULT_MTU;\n+\tu16 mtu = 0;\n \tu16 result = L2CAP_CONF_SUCCESS;\n \tu16 size;\n \n@@ -3520,6 +3520,13 @@ static int l2cap_parse_conf_req(struct l2cap_chan *chan, void *data, size_t data\n \t\t/* Configure output options and let the other side know\n \t\t * which ones we don't like. */\n \n+\t\t/* If MTU is not provided in configure request, use the most recently\n+\t\t * explicitly or implicitly accepted value for the other direction,\n+\t\t * or the default value.\n+\t\t */\n+\t\tif (mtu == 0)\n+\t\t\tmtu = chan->imtu ? chan->imtu : L2CAP_DEFAULT_MTU;\n+\n \t\tif (mtu < L2CAP_DEFAULT_MIN_MTU)\n \t\t\tresult = L2CAP_CONF_UNACCEPT;\n \t\telse {\ndiff --git a/net/bridge/br_multicast.c b/net/bridge/br_multicast.c\nindex 0224ef3dfec0..1377f31b719c 100644\n--- a/net/bridge/br_multicast.c\n+++ b/net/bridge/br_multicast.c\n@@ -2015,10 +2015,19 @@ void br_multicast_port_ctx_init(struct net_bridge_port *port,\n \n void br_multicast_port_ctx_deinit(struct net_bridge_mcast_port *pmctx)\n {\n+\tstruct net_bridge *br = pmctx->port->br;\n+\tbool del = false;\n+\n #if IS_ENABLED(CONFIG_IPV6)\n \ttimer_delete_sync(&pmctx->ip6_mc_router_timer);\n #endif\n \ttimer_delete_sync(&pmctx->ip4_mc_router_timer);\n+\n+\tspin_lock_bh(&br->multicast_lock);\n+\tdel |= br_ip6_multicast_rport_del(pmctx);\n+\tdel |= br_ip4_multicast_rport_del(pmctx);\n+\tbr_multicast_rport_del_notify(pmctx, del);\n+\tspin_unlock_bh(&br->multicast_lock);\n }\n \n int br_multicast_add_port(struct net_bridge_port *port)\ndiff --git a/net/core/netpoll.c b/net/core/netpoll.c\nindex 4ddb7490df4b..6ad84d4a2b46 100644\n--- a/net/core/netpoll.c\n+++ b/net/core/netpoll.c\n@@ -432,6 +432,7 @@ int netpoll_send_udp(struct netpoll *np, const char *msg, int len)\n \tudph->dest = htons(np->remote_port);\n \tudph->len = htons(udp_len);\n \n+\tudph->check = 0;\n \tif (np->ipv6) {\n \t\tudph->check = csum_ipv6_magic(&np->local_ip.in6,\n \t\t\t\t\t      &np->remote_ip.in6,\n@@ -460,7 +461,6 @@ int netpoll_send_udp(struct netpoll *np, const char *msg, int len)\n \t\tskb_reset_mac_header(skb);\n \t\tskb->protocol = eth->h_proto = htons(ETH_P_IPV6);\n \t} else {\n-\t\tudph->check = 0;\n \t\tudph->check = csum_tcpudp_magic(np->local_ip.ip,\n \t\t\t\t\t\tnp->remote_ip.ip,\n \t\t\t\t\t\tudp_len, IPPROTO_UDP,\ndiff --git a/net/core/selftests.c b/net/core/selftests.c\nindex 35f807ea9952..406faf8e5f3f 100644\n--- a/net/core/selftests.c\n+++ b/net/core/selftests.c\n@@ -160,8 +160,9 @@ static struct sk_buff *net_test_get_skb(struct net_device *ndev,\n \tskb->csum = 0;\n \tskb->ip_summed = CHECKSUM_PARTIAL;\n \tif (attr->tcp) {\n-\t\tthdr->check = ~tcp_v4_check(skb->len, ihdr->saddr,\n-\t\t\t\t\t    ihdr->daddr, 0);\n+\t\tint l4len = skb->len - skb_transport_offset(skb);\n+\n+\t\tthdr->check = ~tcp_v4_check(l4len, ihdr->saddr, ihdr->daddr, 0);\n \t\tskb->csum_start = skb_transport_header(skb) - skb->head;\n \t\tskb->csum_offset = offsetof(struct tcphdr, check);\n \t} else {\ndiff --git a/net/mac80211/link.c b/net/mac80211/link.c\nindex d40c2bd3b50b..4f7b7d0f64f2 100644\n--- a/net/mac80211/link.c\n+++ b/net/mac80211/link.c\n@@ -93,9 +93,6 @@ void ieee80211_link_init(struct ieee80211_sub_if_data *sdata,\n \tif (link_id < 0)\n \t\tlink_id = 0;\n \n-\trcu_assign_pointer(sdata->vif.link_conf[link_id], link_conf);\n-\trcu_assign_pointer(sdata->link[link_id], link);\n-\n \tif (sdata->vif.type == NL80211_IFTYPE_AP_VLAN) {\n \t\tstruct ieee80211_sub_if_data *ap_bss;\n \t\tstruct ieee80211_bss_conf *ap_bss_conf;\n@@ -145,6 +142,9 @@ void ieee80211_link_init(struct ieee80211_sub_if_data *sdata,\n \n \t\tieee80211_link_debugfs_add(link);\n \t}\n+\n+\trcu_assign_pointer(sdata->vif.link_conf[link_id], link_conf);\n+\trcu_assign_pointer(sdata->link[link_id], link);\n }\n \n void ieee80211_link_stop(struct ieee80211_link_data *link)\ndiff --git a/net/mac80211/util.c b/net/mac80211/util.c\nindex 27d414efa3fd..a125995ed252 100644\n--- a/net/mac80211/util.c\n+++ b/net/mac80211/util.c\n@@ -3884,7 +3884,7 @@ void ieee80211_recalc_dtim(struct ieee80211_local *local,\n {\n \tu64 tsf = drv_get_tsf(local, sdata);\n \tu64 dtim_count = 0;\n-\tu16 beacon_int = sdata->vif.bss_conf.beacon_int * 1024;\n+\tu32 beacon_int = sdata->vif.bss_conf.beacon_int * 1024;\n \tu8 dtim_period = sdata->vif.bss_conf.dtim_period;\n \tstruct ps_data *ps;\n \tu8 bcns_from_dtim;\ndiff --git a/net/unix/af_unix.c b/net/unix/af_unix.c\nindex 22e170fb5dda..52b155123985 100644\n--- a/net/unix/af_unix.c\n+++ b/net/unix/af_unix.c\n@@ -660,6 +660,11 @@ static void unix_sock_destructor(struct sock *sk)\n #endif\n }\n \n+static unsigned int unix_skb_len(const struct sk_buff *skb)\n+{\n+\treturn skb->len - UNIXCB(skb).consumed;\n+}\n+\n static void unix_release_sock(struct sock *sk, int embrion)\n {\n \tstruct unix_sock *u = unix_sk(sk);\n@@ -694,10 +699,16 @@ static void unix_release_sock(struct sock *sk, int embrion)\n \n \tif (skpair != NULL) {\n \t\tif (sk->sk_type == SOCK_STREAM || sk->sk_type == SOCK_SEQPACKET) {\n+\t\t\tstruct sk_buff *skb = skb_peek(&sk->sk_receive_queue);\n+\n+#if IS_ENABLED(CONFIG_AF_UNIX_OOB)\n+\t\t\tif (skb && !unix_skb_len(skb))\n+\t\t\t\tskb = skb_peek_next(skb, &sk->sk_receive_queue);\n+#endif\n \t\t\tunix_state_lock(skpair);\n \t\t\t/* No more writes */\n \t\t\tWRITE_ONCE(skpair->sk_shutdown, SHUTDOWN_MASK);\n-\t\t\tif (!skb_queue_empty_lockless(&sk->sk_receive_queue) || embrion)\n+\t\t\tif (skb || embrion)\n \t\t\t\tWRITE_ONCE(skpair->sk_err, ECONNRESET);\n \t\t\tunix_state_unlock(skpair);\n \t\t\tskpair->sk_state_change(skpair);\n@@ -2661,11 +2672,6 @@ static long unix_stream_data_wait(struct sock *sk, long timeo,\n \treturn timeo;\n }\n \n-static unsigned int unix_skb_len(const struct sk_buff *skb)\n-{\n-\treturn skb->len - UNIXCB(skb).consumed;\n-}\n-\n struct unix_stream_read_state {\n \tint (*recv_actor)(struct sk_buff *, int, int,\n \t\t\t  struct unix_stream_read_state *);\n@@ -2680,11 +2686,11 @@ struct unix_stream_read_state {\n #if IS_ENABLED(CONFIG_AF_UNIX_OOB)\n static int unix_stream_recv_urg(struct unix_stream_read_state *state)\n {\n+\tstruct sk_buff *oob_skb, *read_skb = NULL;\n \tstruct socket *sock = state->socket;\n \tstruct sock *sk = sock->sk;\n \tstruct unix_sock *u = unix_sk(sk);\n \tint chunk = 1;\n-\tstruct sk_buff *oob_skb;\n \n \tmutex_lock(&u->iolock);\n \tunix_state_lock(sk);\n@@ -2699,9 +2705,16 @@ static int unix_stream_recv_urg(struct unix_stream_read_state *state)\n \n \toob_skb = u->oob_skb;\n \n-\tif (!(state->flags & MSG_PEEK))\n+\tif (!(state->flags & MSG_PEEK)) {\n \t\tWRITE_ONCE(u->oob_skb, NULL);\n \n+\t\tif (oob_skb->prev != (struct sk_buff *)&sk->sk_receive_queue &&\n+\t\t    !unix_skb_len(oob_skb->prev)) {\n+\t\t\tread_skb = oob_skb->prev;\n+\t\t\t__skb_unlink(read_skb, &sk->sk_receive_queue);\n+\t\t}\n+\t}\n+\n \tspin_unlock(&sk->sk_receive_queue.lock);\n \tunix_state_unlock(sk);\n \n@@ -2712,6 +2725,8 @@ static int unix_stream_recv_urg(struct unix_stream_read_state *state)\n \n \tmutex_unlock(&u->iolock);\n \n+\tconsume_skb(read_skb);\n+\n \tif (chunk < 0)\n \t\treturn -EFAULT;\n \ndiff --git a/tools/testing/selftests/drivers/net/hw/rss_input_xfrm.py b/tools/testing/selftests/drivers/net/hw/rss_input_xfrm.py\nindex f439c434ba36..648ff50bc1c3 100755\n--- a/tools/testing/selftests/drivers/net/hw/rss_input_xfrm.py\n+++ b/tools/testing/selftests/drivers/net/hw/rss_input_xfrm.py\n@@ -38,7 +38,7 @@ def test_rss_input_xfrm(cfg, ipver):\n         raise KsftSkipEx(\"socket.SO_INCOMING_CPU was added in Python 3.11\")\n \n     input_xfrm = cfg.ethnl.rss_get(\n-        {'header': {'dev-name': cfg.ifname}}).get('input_xfrm')\n+        {'header': {'dev-name': cfg.ifname}}).get('input-xfrm')\n \n     # Check for symmetric xor/or-xor\n     if not input_xfrm or (input_xfrm != 1 and input_xfrm != 2):\ndiff --git a/tools/testing/selftests/net/af_unix/msg_oob.c b/tools/testing/selftests/net/af_unix/msg_oob.c\nindex 3ed3882a93b8..b5f474969917 100644\n--- a/tools/testing/selftests/net/af_unix/msg_oob.c\n+++ b/tools/testing/selftests/net/af_unix/msg_oob.c\n@@ -210,7 +210,7 @@ static void __sendpair(struct __test_metadata *_metadata,\n static void __recvpair(struct __test_metadata *_metadata,\n \t\t       FIXTURE_DATA(msg_oob) *self,\n \t\t       const char *expected_buf, int expected_len,\n-\t\t       int buf_len, int flags)\n+\t\t       int buf_len, int flags, bool is_sender)\n {\n \tint i, ret[2], recv_errno[2], expected_errno = 0;\n \tchar recv_buf[2][BUF_SZ] = {};\n@@ -221,7 +221,9 @@ static void __recvpair(struct __test_metadata *_metadata,\n \terrno = 0;\n \n \tfor (i = 0; i < 2; i++) {\n-\t\tret[i] = recv(self->fd[i * 2 + 1], recv_buf[i], buf_len, flags);\n+\t\tint index = is_sender ? i * 2 : i * 2 + 1;\n+\n+\t\tret[i] = recv(self->fd[index], recv_buf[i], buf_len, flags);\n \t\trecv_errno[i] = errno;\n \t}\n \n@@ -308,6 +310,20 @@ static void __siocatmarkpair(struct __test_metadata *_metadata,\n \t\tASSERT_EQ(answ[0], answ[1]);\n }\n \n+static void __resetpair(struct __test_metadata *_metadata,\n+\t\t\tFIXTURE_DATA(msg_oob) *self,\n+\t\t\tconst FIXTURE_VARIANT(msg_oob) *variant,\n+\t\t\tbool reset)\n+{\n+\tint i;\n+\n+\tfor (i = 0; i < 2; i++)\n+\t\tclose(self->fd[i * 2 + 1]);\n+\n+\t__recvpair(_metadata, self, \"\", reset ? -ECONNRESET : 0, 1,\n+\t\t   variant->peek ? MSG_PEEK : 0, true);\n+}\n+\n #define sendpair(buf, len, flags)\t\t\t\t\t\\\n \t__sendpair(_metadata, self, buf, len, flags)\n \n@@ -316,9 +332,10 @@ static void __siocatmarkpair(struct __test_metadata *_metadata,\n \t\tif (variant->peek)\t\t\t\t\t\\\n \t\t\t__recvpair(_metadata, self,\t\t\t\\\n \t\t\t\t   expected_buf, expected_len,\t\t\\\n-\t\t\t\t   buf_len, (flags) | MSG_PEEK);\t\\\n+\t\t\t\t   buf_len, (flags) | MSG_PEEK, false);\t\\\n \t\t__recvpair(_metadata, self,\t\t\t\t\\\n-\t\t\t   expected_buf, expected_len, buf_len, flags);\t\\\n+\t\t\t   expected_buf, expected_len,\t\t\t\\\n+\t\t\t   buf_len, flags, false);\t\t\t\\\n \t} while (0)\n \n #define epollpair(oob_remaining)\t\t\t\t\t\\\n@@ -330,6 +347,9 @@ static void __siocatmarkpair(struct __test_metadata *_metadata,\n #define setinlinepair()\t\t\t\t\t\t\t\\\n \t__setinlinepair(_metadata, self)\n \n+#define resetpair(reset)\t\t\t\t\t\t\\\n+\t__resetpair(_metadata, self, variant, reset)\n+\n #define tcp_incompliant\t\t\t\t\t\t\t\\\n \tfor (self->tcp_compliant = false;\t\t\t\t\\\n \t     self->tcp_compliant == false;\t\t\t\t\\\n@@ -344,6 +364,21 @@ TEST_F(msg_oob, non_oob)\n \trecvpair(\"\", -EINVAL, 1, MSG_OOB);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(true);\n+}\n+\n+TEST_F(msg_oob, non_oob_no_reset)\n+{\n+\tsendpair(\"x\", 1, 0);\n+\tepollpair(false);\n+\tsiocatmarkpair(false);\n+\n+\trecvpair(\"x\", 1, 1, 0);\n+\tepollpair(false);\n+\tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, oob)\n@@ -355,6 +390,19 @@ TEST_F(msg_oob, oob)\n \trecvpair(\"x\", 1, 1, MSG_OOB);\n \tepollpair(false);\n \tsiocatmarkpair(true);\n+\n+\ttcp_incompliant {\n+\t\tresetpair(false);\t\t/* TCP sets -ECONNRESET for ex-OOB. */\n+\t}\n+}\n+\n+TEST_F(msg_oob, oob_reset)\n+{\n+\tsendpair(\"x\", 1, MSG_OOB);\n+\tepollpair(true);\n+\tsiocatmarkpair(true);\n+\n+\tresetpair(true);\n }\n \n TEST_F(msg_oob, oob_drop)\n@@ -370,6 +418,8 @@ TEST_F(msg_oob, oob_drop)\n \trecvpair(\"\", -EINVAL, 1, MSG_OOB);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, oob_ahead)\n@@ -385,6 +435,10 @@ TEST_F(msg_oob, oob_ahead)\n \trecvpair(\"hell\", 4, 4, 0);\n \tepollpair(false);\n \tsiocatmarkpair(true);\n+\n+\ttcp_incompliant {\n+\t\tresetpair(false);\t\t/* TCP sets -ECONNRESET for ex-OOB. */\n+\t}\n }\n \n TEST_F(msg_oob, oob_break)\n@@ -403,6 +457,8 @@ TEST_F(msg_oob, oob_break)\n \n \trecvpair(\"\", -EAGAIN, 1, 0);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, oob_ahead_break)\n@@ -426,6 +482,8 @@ TEST_F(msg_oob, oob_ahead_break)\n \trecvpair(\"world\", 5, 5, 0);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, oob_break_drop)\n@@ -449,6 +507,8 @@ TEST_F(msg_oob, oob_break_drop)\n \trecvpair(\"\", -EINVAL, 1, MSG_OOB);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, ex_oob_break)\n@@ -476,6 +536,8 @@ TEST_F(msg_oob, ex_oob_break)\n \trecvpair(\"ld\", 2, 2, 0);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, ex_oob_drop)\n@@ -498,6 +560,8 @@ TEST_F(msg_oob, ex_oob_drop)\n \t\tepollpair(false);\n \t\tsiocatmarkpair(true);\n \t}\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, ex_oob_drop_2)\n@@ -523,6 +587,8 @@ TEST_F(msg_oob, ex_oob_drop_2)\n \t\tepollpair(false);\n \t\tsiocatmarkpair(true);\n \t}\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, ex_oob_oob)\n@@ -546,6 +612,54 @@ TEST_F(msg_oob, ex_oob_oob)\n \trecvpair(\"\", -EINVAL, 1, MSG_OOB);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n+}\n+\n+TEST_F(msg_oob, ex_oob_ex_oob)\n+{\n+\tsendpair(\"x\", 1, MSG_OOB);\n+\tepollpair(true);\n+\tsiocatmarkpair(true);\n+\n+\trecvpair(\"x\", 1, 1, MSG_OOB);\n+\tepollpair(false);\n+\tsiocatmarkpair(true);\n+\n+\tsendpair(\"y\", 1, MSG_OOB);\n+\tepollpair(true);\n+\tsiocatmarkpair(true);\n+\n+\trecvpair(\"y\", 1, 1, MSG_OOB);\n+\tepollpair(false);\n+\tsiocatmarkpair(true);\n+\n+\ttcp_incompliant {\n+\t\tresetpair(false);\t\t/* TCP sets -ECONNRESET for ex-OOB. */\n+\t}\n+}\n+\n+TEST_F(msg_oob, ex_oob_ex_oob_oob)\n+{\n+\tsendpair(\"x\", 1, MSG_OOB);\n+\tepollpair(true);\n+\tsiocatmarkpair(true);\n+\n+\trecvpair(\"x\", 1, 1, MSG_OOB);\n+\tepollpair(false);\n+\tsiocatmarkpair(true);\n+\n+\tsendpair(\"y\", 1, MSG_OOB);\n+\tepollpair(true);\n+\tsiocatmarkpair(true);\n+\n+\trecvpair(\"y\", 1, 1, MSG_OOB);\n+\tepollpair(false);\n+\tsiocatmarkpair(true);\n+\n+\tsendpair(\"z\", 1, MSG_OOB);\n+\tepollpair(true);\n+\tsiocatmarkpair(true);\n }\n \n TEST_F(msg_oob, ex_oob_ahead_break)\n@@ -576,6 +690,10 @@ TEST_F(msg_oob, ex_oob_ahead_break)\n \trecvpair(\"d\", 1, 1, MSG_OOB);\n \tepollpair(false);\n \tsiocatmarkpair(true);\n+\n+\ttcp_incompliant {\n+\t\tresetpair(false);\t\t/* TCP sets -ECONNRESET for ex-OOB. */\n+\t}\n }\n \n TEST_F(msg_oob, ex_oob_siocatmark)\n@@ -595,6 +713,8 @@ TEST_F(msg_oob, ex_oob_siocatmark)\n \trecvpair(\"hell\", 4, 4, 0);\t\t/* Intentionally stop at ex-OOB. */\n \tepollpair(true);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(true);\n }\n \n TEST_F(msg_oob, inline_oob)\n@@ -612,6 +732,8 @@ TEST_F(msg_oob, inline_oob)\n \trecvpair(\"x\", 1, 1, 0);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, inline_oob_break)\n@@ -633,6 +755,8 @@ TEST_F(msg_oob, inline_oob_break)\n \trecvpair(\"o\", 1, 1, 0);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, inline_oob_ahead_break)\n@@ -661,6 +785,8 @@ TEST_F(msg_oob, inline_oob_ahead_break)\n \n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, inline_ex_oob_break)\n@@ -686,6 +812,8 @@ TEST_F(msg_oob, inline_ex_oob_break)\n \trecvpair(\"rld\", 3, 3, 0);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, inline_ex_oob_no_drop)\n@@ -707,6 +835,8 @@ TEST_F(msg_oob, inline_ex_oob_no_drop)\n \trecvpair(\"y\", 1, 1, 0);\n \tepollpair(false);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, inline_ex_oob_drop)\n@@ -731,6 +861,8 @@ TEST_F(msg_oob, inline_ex_oob_drop)\n \t\tepollpair(false);\n \t\tsiocatmarkpair(false);\n \t}\n+\n+\tresetpair(false);\n }\n \n TEST_F(msg_oob, inline_ex_oob_siocatmark)\n@@ -752,6 +884,8 @@ TEST_F(msg_oob, inline_ex_oob_siocatmark)\n \trecvpair(\"hell\", 4, 4, 0);\t\t/* Intentionally stop at ex-OOB. */\n \tepollpair(true);\n \tsiocatmarkpair(false);\n+\n+\tresetpair(true);\n }\n \n TEST_HARNESS_MAIN",
    "stats": {
      "insertions": 378,
      "deletions": 116,
      "files": 41
    }
  },
  {
    "sha": "711741f94ac3cf9f4e3aa73aa171e76d188c0819",
    "message": "smb: client: fix potential deadlock when reconnecting channels\n\nFix cifs_signal_cifsd_for_reconnect() to take the correct lock order\nand prevent the following deadlock from happening\n\n======================================================\nWARNING: possible circular locking dependency detected\n6.16.0-rc3-build2+ #1301 Tainted: G S      W\n------------------------------------------------------\ncifsd/6055 is trying to acquire lock:\nffff88810ad56038 (&tcp_ses->srv_lock){+.+.}-{3:3}, at: cifs_signal_cifsd_for_reconnect+0x134/0x200\n\nbut task is already holding lock:\nffff888119c64330 (&ret_buf->chan_lock){+.+.}-{3:3}, at: cifs_signal_cifsd_for_reconnect+0xcf/0x200\n\nwhich lock already depends on the new lock.\n\nthe existing dependency chain (in reverse order) is:\n\n-> #2 (&ret_buf->chan_lock){+.+.}-{3:3}:\n       validate_chain+0x1cf/0x270\n       __lock_acquire+0x60e/0x780\n       lock_acquire.part.0+0xb4/0x1f0\n       _raw_spin_lock+0x2f/0x40\n       cifs_setup_session+0x81/0x4b0\n       cifs_get_smb_ses+0x771/0x900\n       cifs_mount_get_session+0x7e/0x170\n       cifs_mount+0x92/0x2d0\n       cifs_smb3_do_mount+0x161/0x460\n       smb3_get_tree+0x55/0x90\n       vfs_get_tree+0x46/0x180\n       do_new_mount+0x1b0/0x2e0\n       path_mount+0x6ee/0x740\n       do_mount+0x98/0xe0\n       __do_sys_mount+0x148/0x180\n       do_syscall_64+0xa4/0x260\n       entry_SYSCALL_64_after_hwframe+0x76/0x7e\n\n-> #1 (&ret_buf->ses_lock){+.+.}-{3:3}:\n       validate_chain+0x1cf/0x270\n       __lock_acquire+0x60e/0x780\n       lock_acquire.part.0+0xb4/0x1f0\n       _raw_spin_lock+0x2f/0x40\n       cifs_match_super+0x101/0x320\n       sget+0xab/0x270\n       cifs_smb3_do_mount+0x1e0/0x460\n       smb3_get_tree+0x55/0x90\n       vfs_get_tree+0x46/0x180\n       do_new_mount+0x1b0/0x2e0\n       path_mount+0x6ee/0x740\n       do_mount+0x98/0xe0\n       __do_sys_mount+0x148/0x180\n       do_syscall_64+0xa4/0x260\n       entry_SYSCALL_64_after_hwframe+0x76/0x7e\n\n-> #0 (&tcp_ses->srv_lock){+.+.}-{3:3}:\n       check_noncircular+0x95/0xc0\n       check_prev_add+0x115/0x2f0\n       validate_chain+0x1cf/0x270\n       __lock_acquire+0x60e/0x780\n       lock_acquire.part.0+0xb4/0x1f0\n       _raw_spin_lock+0x2f/0x40\n       cifs_signal_cifsd_for_reconnect+0x134/0x200\n       __cifs_reconnect+0x8f/0x500\n       cifs_handle_standard+0x112/0x280\n       cifs_demultiplex_thread+0x64d/0xbc0\n       kthread+0x2f7/0x310\n       ret_from_fork+0x2a/0x230\n       ret_from_fork_asm+0x1a/0x30\n\nother info that might help us debug this:\n\nChain exists of:\n  &tcp_ses->srv_lock --> &ret_buf->ses_lock --> &ret_buf->chan_lock\n\n Possible unsafe locking scenario:\n\n       CPU0                    CPU1\n       ----                    ----\n  lock(&ret_buf->chan_lock);\n                               lock(&ret_buf->ses_lock);\n                               lock(&ret_buf->chan_lock);\n  lock(&tcp_ses->srv_lock);\n\n *** DEADLOCK ***\n\n3 locks held by cifsd/6055:\n #0: ffffffff857de398 (&cifs_tcp_ses_lock){+.+.}-{3:3}, at: cifs_signal_cifsd_for_reconnect+0x7b/0x200\n #1: ffff888119c64060 (&ret_buf->ses_lock){+.+.}-{3:3}, at: cifs_signal_cifsd_for_reconnect+0x9c/0x200\n #2: ffff888119c64330 (&ret_buf->chan_lock){+.+.}-{3:3}, at: cifs_signal_cifsd_for_reconnect+0xcf/0x200\n\nCc: linux-cifs@vger.kernel.org\nReported-by: David Howells <dhowells@redhat.com>\nFixes: d7d7a66aacd6 (\"cifs: avoid use of global locks for high contention data\")\nReviewed-by: David Howells <dhowells@redhat.com>\nTested-by: David Howells <dhowells@redhat.com>\nSigned-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.org>\nSigned-off-by: David Howells <dhowells@redhat.com>\nSigned-off-by: Steve French <stfrench@microsoft.com>",
    "author": "Paulo Alcantara",
    "date": "2025-06-26T11:12:04-05:00",
    "files_changed": [
      "fs/smb/client/cifsglob.h",
      "fs/smb/client/connect.c"
    ],
    "diff": "diff --git a/fs/smb/client/cifsglob.h b/fs/smb/client/cifsglob.h\nindex 45e94e18f4d5..318a8405d475 100644\n--- a/fs/smb/client/cifsglob.h\n+++ b/fs/smb/client/cifsglob.h\n@@ -709,6 +709,7 @@ inc_rfc1001_len(void *buf, int count)\n struct TCP_Server_Info {\n \tstruct list_head tcp_ses_list;\n \tstruct list_head smb_ses_list;\n+\tstruct list_head rlist; /* reconnect list */\n \tspinlock_t srv_lock;  /* protect anything here that is not protected */\n \t__u64 conn_id; /* connection identifier (useful for debugging) */\n \tint srv_count; /* reference counter */\ndiff --git a/fs/smb/client/connect.c b/fs/smb/client/connect.c\nindex c48869c29e15..685c65dcb8c4 100644\n--- a/fs/smb/client/connect.c\n+++ b/fs/smb/client/connect.c\n@@ -124,6 +124,14 @@ static void smb2_query_server_interfaces(struct work_struct *work)\n \t\t\t   (SMB_INTERFACE_POLL_INTERVAL * HZ));\n }\n \n+#define set_need_reco(server) \\\n+do { \\\n+\tspin_lock(&server->srv_lock); \\\n+\tif (server->tcpStatus != CifsExiting) \\\n+\t\tserver->tcpStatus = CifsNeedReconnect; \\\n+\tspin_unlock(&server->srv_lock); \\\n+} while (0)\n+\n /*\n  * Update the tcpStatus for the server.\n  * This is used to signal the cifsd thread to call cifs_reconnect\n@@ -137,39 +145,45 @@ void\n cifs_signal_cifsd_for_reconnect(struct TCP_Server_Info *server,\n \t\t\t\tbool all_channels)\n {\n-\tstruct TCP_Server_Info *pserver;\n+\tstruct TCP_Server_Info *nserver;\n \tstruct cifs_ses *ses;\n+\tLIST_HEAD(reco);\n \tint i;\n \n-\t/* If server is a channel, select the primary channel */\n-\tpserver = SERVER_IS_CHAN(server) ? server->primary_server : server;\n-\n \t/* if we need to signal just this channel */\n \tif (!all_channels) {\n-\t\tspin_lock(&server->srv_lock);\n-\t\tif (server->tcpStatus != CifsExiting)\n-\t\t\tserver->tcpStatus = CifsNeedReconnect;\n-\t\tspin_unlock(&server->srv_lock);\n+\t\tset_need_reco(server);\n \t\treturn;\n \t}\n \n-\tspin_lock(&cifs_tcp_ses_lock);\n-\tlist_for_each_entry(ses, &pserver->smb_ses_list, smb_ses_list) {\n-\t\tif (cifs_ses_exiting(ses))\n-\t\t\tcontinue;\n-\t\tspin_lock(&ses->chan_lock);\n-\t\tfor (i = 0; i < ses->chan_count; i++) {\n-\t\t\tif (!ses->chans[i].server)\n+\tif (SERVER_IS_CHAN(server))\n+\t\tserver = server->primary_server;\n+\tscoped_guard(spinlock, &cifs_tcp_ses_lock) {\n+\t\tset_need_reco(server);\n+\t\tlist_for_each_entry(ses, &server->smb_ses_list, smb_ses_list) {\n+\t\t\tspin_lock(&ses->ses_lock);\n+\t\t\tif (ses->ses_status == SES_EXITING) {\n+\t\t\t\tspin_unlock(&ses->ses_lock);\n \t\t\t\tcontinue;\n-\n-\t\t\tspin_lock(&ses->chans[i].server->srv_lock);\n-\t\t\tif (ses->chans[i].server->tcpStatus != CifsExiting)\n-\t\t\t\tses->chans[i].server->tcpStatus = CifsNeedReconnect;\n-\t\t\tspin_unlock(&ses->chans[i].server->srv_lock);\n+\t\t\t}\n+\t\t\tspin_lock(&ses->chan_lock);\n+\t\t\tfor (i = 1; i < ses->chan_count; i++) {\n+\t\t\t\tnserver = ses->chans[i].server;\n+\t\t\t\tif (!nserver)\n+\t\t\t\t\tcontinue;\n+\t\t\t\tnserver->srv_count++;\n+\t\t\t\tlist_add(&nserver->rlist, &reco);\n+\t\t\t}\n+\t\t\tspin_unlock(&ses->chan_lock);\n+\t\t\tspin_unlock(&ses->ses_lock);\n \t\t}\n-\t\tspin_unlock(&ses->chan_lock);\n \t}\n-\tspin_unlock(&cifs_tcp_ses_lock);\n+\n+\tlist_for_each_entry_safe(server, nserver, &reco, rlist) {\n+\t\tlist_del_init(&server->rlist);\n+\t\tset_need_reco(server);\n+\t\tcifs_put_tcp_session(server, 0);\n+\t}\n }\n \n /*",
    "stats": {
      "insertions": 37,
      "deletions": 22,
      "files": 2
    }
  },
  {
    "sha": "d07143b507c51c04c091081627c5a130e9d3c517",
    "message": "platform/mellanox: nvsw-sn2201: Fix bus number in adapter error message\n\nchange error log to use correct bus number from main_mux_devs\ninstead of cpld_devs.\n\nFixes: 662f24826f95 (\"platform/mellanox: Add support for new SN2201 system\")\nSigned-off-by: Alok Tiwari <alok.a.tiwari@oracle.com>\nReviewed-by: Vadim Pasternak <vadimp@nvidia.com>\nLink: https://lore.kernel.org/r/20250622072921.4111552-2-alok.a.tiwari@oracle.com\nSigned-off-by: Ilpo Järvinen <ilpo.jarvinen@linux.intel.com>",
    "author": "Alok Tiwari",
    "date": "2025-06-26T17:14:31+03:00",
    "files_changed": [
      "drivers/platform/mellanox/nvsw-sn2201.c"
    ],
    "diff": "diff --git a/drivers/platform/mellanox/nvsw-sn2201.c b/drivers/platform/mellanox/nvsw-sn2201.c\nindex db31c8bf2255..51504113c17e 100644\n--- a/drivers/platform/mellanox/nvsw-sn2201.c\n+++ b/drivers/platform/mellanox/nvsw-sn2201.c\n@@ -1181,7 +1181,7 @@ static int nvsw_sn2201_i2c_completion_notify(void *handle, int id)\n \tif (!nvsw_sn2201->main_mux_devs->adapter) {\n \t\terr = -ENODEV;\n \t\tdev_err(nvsw_sn2201->dev, \"Failed to get adapter for bus %d\\n\",\n-\t\t\tnvsw_sn2201->cpld_devs->nr);\n+\t\t\tnvsw_sn2201->main_mux_devs->nr);\n \t\tgoto i2c_get_adapter_main_fail;\n \t}\n ",
    "stats": {
      "insertions": 1,
      "deletions": 1,
      "files": 1
    }
  },
  {
    "sha": "c007062188d8e402c294117db53a24b2bed2b83f",
    "message": "block: fix false warning in bdev_count_inflight_rw()\n\nWhile bdev_count_inflight is interating all cpus, if some IOs are issued\nfrom traversed cpu and then completed from the cpu that is not traversed\nyet:\n\ncpu0\n\t\tcpu1\n\t\tbdev_count_inflight\n\t\t //for_each_possible_cpu\n\t\t // cpu0 is 0\n\t\t infliht += 0\n// issue a io\nblk_account_io_start\n// cpu0 inflight ++\n\n\t\t\t\tcpu2\n\t\t\t\t// the io is done\n\t\t\t\tblk_account_io_done\n\t\t\t\t// cpu2 inflight --\n\t\t // cpu 1 is 0\n\t\t inflight += 0\n\t\t // cpu2 is -1\n\t\t inflight += -1\n\t\t ...\n\nIn this case, the total inflight will be -1, causing lots of false\nwarning. Fix the problem by removing the warning.\n\nNoted there is still a valid warning for nvme-mpath(From Yi) that is not\nfixed yet.\n\nFixes: f5482ee5edb9 (\"block: WARN if bdev inflight counter is negative\")\nReported-by: Yi Zhang <yi.zhang@redhat.com>\nCloses: https://lore.kernel.org/linux-block/aFtUXy-lct0WxY2w@mozart.vkv.me/T/#mae89155a5006463d0a21a4a2c35ae0034b26a339\nReported-and-tested-by: Calvin Owens <calvin@wbinvd.org>\nCloses: https://lore.kernel.org/linux-block/aFtUXy-lct0WxY2w@mozart.vkv.me/T/#m1d935a00070bf95055d0ac84e6075158b08acaef\nReported-by: Dave Chinner <david@fromorbit.com>\nCloses: https://lore.kernel.org/linux-block/aFuypjqCXo9-5_En@dread.disaster.area/\nSigned-off-by: Yu Kuai <yukuai3@huawei.com>\nLink: https://lore.kernel.org/r/20250626115743.1641443-1-yukuai3@huawei.com\nReviewed-by: Christoph Hellwig <hch@lst.de>\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
    "author": "Yu Kuai",
    "date": "2025-06-26T07:34:11-06:00",
    "files_changed": [
      "block/genhd.c"
    ],
    "diff": "diff --git a/block/genhd.c b/block/genhd.c\nindex 8171a6bc3210..c26733f6324b 100644\n--- a/block/genhd.c\n+++ b/block/genhd.c\n@@ -128,23 +128,27 @@ static void part_stat_read_all(struct block_device *part,\n static void bdev_count_inflight_rw(struct block_device *part,\n \t\tunsigned int inflight[2], bool mq_driver)\n {\n+\tint write = 0;\n+\tint read = 0;\n \tint cpu;\n \n \tif (mq_driver) {\n \t\tblk_mq_in_driver_rw(part, inflight);\n-\t} else {\n-\t\tfor_each_possible_cpu(cpu) {\n-\t\t\tinflight[READ] += part_stat_local_read_cpu(\n-\t\t\t\t\t\tpart, in_flight[READ], cpu);\n-\t\t\tinflight[WRITE] += part_stat_local_read_cpu(\n-\t\t\t\t\t\tpart, in_flight[WRITE], cpu);\n-\t\t}\n+\t\treturn;\n+\t}\n+\n+\tfor_each_possible_cpu(cpu) {\n+\t\tread += part_stat_local_read_cpu(part, in_flight[READ], cpu);\n+\t\twrite += part_stat_local_read_cpu(part, in_flight[WRITE], cpu);\n \t}\n \n-\tif (WARN_ON_ONCE((int)inflight[READ] < 0))\n-\t\tinflight[READ] = 0;\n-\tif (WARN_ON_ONCE((int)inflight[WRITE] < 0))\n-\t\tinflight[WRITE] = 0;\n+\t/*\n+\t * While iterating all CPUs, some IOs may be issued from a CPU already\n+\t * traversed and complete on a CPU that has not yet been traversed,\n+\t * causing the inflight number to be negative.\n+\t */\n+\tinflight[READ] = read > 0 ? read : 0;\n+\tinflight[WRITE] = write > 0 ? write : 0;\n }\n \n /**",
    "stats": {
      "insertions": 15,
      "deletions": 11,
      "files": 1
    }
  },
  {
    "sha": "969127bf0783a4ac0c8a27e633a9e8ea1738583f",
    "message": "ublk: sanity check add_dev input for underflow\n\nAdd additional checks that queue depth and number of queues are\nnon-zero.\n\nSigned-off-by: Ronnie Sahlberg <rsahlberg@whamcloud.com>\nReviewed-by: Ming Lei <ming.lei@redhat.com>\nLink: https://lore.kernel.org/r/20250626022046.235018-1-ronniesahlberg@gmail.com\nSigned-off-by: Jens Axboe <axboe@kernel.dk>",
    "author": "Ronnie Sahlberg",
    "date": "2025-06-26T07:31:24-06:00",
    "files_changed": [
      "drivers/block/ublk_drv.c"
    ],
    "diff": "diff --git a/drivers/block/ublk_drv.c b/drivers/block/ublk_drv.c\nindex d441d3259edb..c3e3c3b65a6d 100644\n--- a/drivers/block/ublk_drv.c\n+++ b/drivers/block/ublk_drv.c\n@@ -2849,7 +2849,8 @@ static int ublk_ctrl_add_dev(const struct ublksrv_ctrl_cmd *header)\n \tif (copy_from_user(&info, argp, sizeof(info)))\n \t\treturn -EFAULT;\n \n-\tif (info.queue_depth > UBLK_MAX_QUEUE_DEPTH || info.nr_hw_queues > UBLK_MAX_NR_QUEUES)\n+\tif (info.queue_depth > UBLK_MAX_QUEUE_DEPTH || !info.queue_depth ||\n+\t    info.nr_hw_queues > UBLK_MAX_NR_QUEUES || !info.nr_hw_queues)\n \t\treturn -EINVAL;\n \n \tif (capable(CAP_SYS_ADMIN))",
    "stats": {
      "insertions": 2,
      "deletions": 1,
      "files": 1
    }
  }
]